{% extends 'manager/base.html' %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}
{% block page_title %}üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}
{% block page_description %}–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º{% endblock %}

{% block extra_css %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
  <!-- –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
  <div class="data-card mb-4">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">–ü–µ—Ä–∏–æ–¥:</label>
        <select name="period" class="form-select" onchange="this.form.submit()">
          <option value="week" {% if period == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
          <option value="month" {% if period == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
          <option value="year" {% if period == 'year' %}selected{% endif %}>–ì–æ–¥</option>
        </select>
      </div>
      <div class="col-md-9">
        <p class="mb-0 text-muted">
          –ü–µ—Ä–∏–æ–¥: {{ start_date|date:"d.m.Y" }} ‚Äî {{ end_date|date:"d.m.Y" }}
        </p>
      </div>
    </form>
  </div>
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –¥–Ω—è–º</h3>
    </div>
    <canvas id="salesChart" style="max-height: 400px;"></canvas>
  </div>
  
  <div class="row g-4">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">–ó–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
              <th>–í—ã—Ä—É—á–∫–∞</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in status_stats %}
              <tr>
                <td>
                  <span class="badge-manager badge-{{ stat.status }}">
                    {{ stat.status|title }}
                  </span>
                </td>
                <td><strong>{{ stat.count }}</strong></td>
                <td><strong>{{ stat.revenue|default:0|floatformat:0 }} ‚ÇΩ</strong></td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>–°–ø–æ—Å–æ–±</th>
              <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in delivery_stats %}
              <tr>
                <td>
                  {% if stat.fulfillment_type == 'delivery' %}
                    üöö –î–æ—Å—Ç–∞–≤–∫–∞
                  {% else %}
                    üì¶ –°–∞–º–æ–≤—ã–≤–æ–∑
                  {% endif %}
                </td>
                <td><strong>{{ stat.count }}</strong></td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ –ø–æ –¥–Ω—è–º
    const salesData = [
      {% for item in daily_sales %}
        {
          day: '{{ item.day|date:"Y-m-d" }}',
          revenue: {{ item.revenue|default:"0"|floatformat:2 }},
          count: {{ item.count|default:"0" }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    const labels = salesData.map(item => {
      const date = new Date(item.day);
      return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    });
    const revenues = salesData.map(item => parseFloat(item.revenue || 0));
    const counts = salesData.map(item => parseInt(item.count || 0));
    
    const ctx = document.getElementById('salesChart');
    if (ctx && salesData.length > 0) {
      new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
              data: revenues,
              borderColor: '#6F2DBD',
              backgroundColor: 'rgba(111, 45, 189, 0.1)',
              yAxisID: 'y',
              tension: 0.4,
              fill: true
            },
            {
              label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤',
              data: counts,
              borderColor: '#A663CC',
              backgroundColor: 'rgba(166, 99, 204, 0.1)',
              yAxisID: 'y1',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              beginAtZero: true,
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    } else {
      ctx.parentElement.innerHTML = '<p class="text-muted text-center py-4">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>';
    }
  </script>
{% endblock %}

