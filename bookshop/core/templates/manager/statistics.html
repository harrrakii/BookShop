{% extends 'manager/base.html' %}

{% block title %}Статистика{% endblock %}
{% block page_title %}Статистика{% endblock %}
{% block page_description %}Детальная аналитика по продажам{% endblock %}

{% block extra_css %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
  <!-- Фильтр периода -->
  <div class="data-card mb-4">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Период:</label>
        <select name="period" class="form-select" onchange="this.form.submit()">
          <option value="week" {% if period == 'week' %}selected{% endif %}>Неделя</option>
          <option value="month" {% if period == 'month' %}selected{% endif %}>Месяц</option>
          <option value="year" {% if period == 'year' %}selected{% endif %}>Год</option>
        </select>
      </div>
      <div class="col-md-9">
        <p class="mb-0 text-muted">
          Период: {{ start_date|date:"d.m.Y" }} — {{ end_date|date:"d.m.Y" }}
        </p>
      </div>
    </form>
  </div>
  
  <!-- Статистика по дням -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Продажи по дням</h3>
    </div>
    <canvas id="salesChart" style="max-height: 400px;"></canvas>
  </div>
  
  <div class="row g-4">
    <!-- Статистика по статусам -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">Заказы по статусам</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>Статус</th>
              <th>Количество</th>
              <th>Выручка</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in status_stats %}
              <tr>
                <td>
                  <span class="badge-manager badge-{{ stat.status }}">
                    {{ stat.status|title }}
                  </span>
                </td>
                <td><strong>{{ stat.count }}</strong></td>
                <td><strong>{{ stat.revenue|default:0|floatformat:0 }} ₽</strong></td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3" class="text-center text-muted">Нет данных</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Статистика по способам доставки -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">Способ получения</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>Способ</th>
              <th>Количество</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in delivery_stats %}
              <tr>
                <td>
                  {% if stat.fulfillment_type == 'delivery' %}
                    Доставка
                  {% else %}
                    Самовывоз
                  {% endif %}
                </td>
                <td><strong>{{ stat.count }}</strong></td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2" class="text-center text-muted">Нет данных</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Статистика по клиентам -->
  <div class="data-card mt-4 mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Статистика по клиентам</h3>
    </div>
    
    <!-- KPI карточки -->
    <div class="stats-grid mb-4">
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Авторизованные клиенты</div>
          <div class="stat-card-icon primary">
            <i class="bi bi-person-check"></i>
          </div>
        </div>
        <div class="stat-card-value">{{ total_customers }}</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Гостевые клиенты</div>
          <div class="stat-card-icon info">
            <i class="bi bi-person"></i>
          </div>
        </div>
        <div class="stat-card-value">{{ total_guest_customers }}</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Новые клиенты</div>
          <div class="stat-card-icon success">
            <i class="bi bi-person-plus"></i>
          </div>
        </div>
        <div class="stat-card-value">{{ new_customers }}</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Общая выручка</div>
          <div class="stat-card-icon success">
            <i class="bi bi-currency-exchange"></i>
          </div>
        </div>
        <div class="stat-card-value">{{ total_revenue|floatformat:0 }} ₽</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Средний чек</div>
          <div class="stat-card-icon warning">
            <i class="bi bi-graph-up"></i>
          </div>
        </div>
        <div class="stat-card-value">{{ avg_order_value|floatformat:0 }} ₽</div>
      </div>
    </div>
    
    <!-- Топ клиентов -->
    <div class="row g-4">
      <div class="col-lg-12">
        <h4 class="mb-3">Топ-20 клиентов (авторизованные)</h4>
        {% if customer_stats %}
          <div class="table-responsive">
            <table class="table-manager">
              <thead>
                <tr>
                  <th>Клиент</th>
                  <th>Email</th>
                  <th>Количество заказов</th>
                  <th>Общая сумма</th>
                  <th>Средний чек</th>
                  <th>Последний заказ</th>
                </tr>
              </thead>
              <tbody>
                {% for stat in customer_stats %}
                <tr>
                  <td>
                    <strong>
                      {% if stat.user__first_name or stat.user__last_name %}
                        {{ stat.user__first_name|default:'' }} {{ stat.user__last_name|default:'' }}
                      {% else %}
                        Клиент #{{ stat.user__id }}
                      {% endif %}
                    </strong>
                  </td>
                  <td>{{ stat.user__email }}</td>
                  <td><strong>{{ stat.total_orders }}</strong></td>
                  <td><strong>{{ stat.total_spent|floatformat:2 }} ₽</strong></td>
                  <td>{{ stat.avg_order_value|floatformat:2 }} ₽</td>
                  <td>{{ stat.last_order_date|date:"d.m.Y H:i" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted text-center py-4">Нет данных по авторизованным клиентам</p>
        {% endif %}
      </div>
    </div>
    
    <!-- Топ гостевых клиентов -->
    {% if guest_stats %}
    <div class="row g-4 mt-2">
      <div class="col-lg-12">
        <h4 class="mb-3">Топ-10 гостевых клиентов (по email)</h4>
        <div class="table-responsive">
          <table class="table-manager">
            <thead>
              <tr>
                <th>Email</th>
                <th>Количество заказов</th>
                <th>Общая сумма</th>
                <th>Средний чек</th>
                <th>Последний заказ</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in guest_stats %}
              <tr>
                <td><strong>{{ stat.email }}</strong></td>
                <td><strong>{{ stat.total_orders }}</strong></td>
                <td><strong>{{ stat.total_spent|floatformat:2 }} ₽</strong></td>
                <td>{{ stat.avg_order_value|floatformat:2 }} ₽</td>
                <td>{{ stat.last_order_date|date:"d.m.Y H:i" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // График продаж по дням
    const salesData = [
      {% for item in daily_sales %}
        {
          day: '{{ item.day|date:"Y-m-d" }}',
          revenue: {{ item.revenue|default:"0"|floatformat:2 }},
          count: {{ item.count|default:"0" }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    const labels = salesData.map(item => {
      const date = new Date(item.day);
      return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    });
    const revenues = salesData.map(item => parseFloat(item.revenue || 0));
    const counts = salesData.map(item => parseInt(item.count || 0));
    
    const ctx = document.getElementById('salesChart');
    if (ctx && salesData.length > 0) {
      new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Выручка (₽)',
              data: revenues,
              borderColor: '#6F2DBD',
              backgroundColor: 'rgba(111, 45, 189, 0.1)',
              yAxisID: 'y',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Количество заказов',
              data: counts,
              borderColor: '#A663CC',
              backgroundColor: 'rgba(166, 99, 204, 0.1)',
              yAxisID: 'y1',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString('ru-RU') + ' ₽';
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              beginAtZero: true,
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    } else {
      ctx.parentElement.innerHTML = '<p class="text-muted text-center py-4">Недостаточно данных для отображения графика</p>';
    }
  </script>
{% endblock %}

