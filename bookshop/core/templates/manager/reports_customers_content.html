  <!-- Фильтры для отчета по клиентам -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Фильтры</h3>
    </div>
    <form method="get" action="{% url 'manager_reports_customers' %}" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Дата от:</label>
        <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Дата до:</label>
        <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-manager btn-manager-primary me-2">
          <i class="bi bi-funnel"></i> Применить фильтры
        </button>
        <a href="{% url 'manager_reports_customers' %}" class="btn btn-manager btn-manager-secondary">
          <i class="bi bi-arrow-counterclockwise"></i> Сбросить
        </a>
      </div>
    </form>
  </div>
  
  <!-- Кнопки экспорта -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Экспорт отчета</h3>
    </div>
    <div class="d-flex gap-3">
      <a href="{% url 'manager_reports_customers_export_csv' %}?{{ request.GET.urlencode }}" class="btn btn-manager btn-manager-primary">
        <i class="bi bi-file-earmark-spreadsheet"></i> Экспорт в CSV
      </a>
      <a href="{% url 'manager_reports_customers_export_image' %}?{{ request.GET.urlencode }}" class="btn btn-manager btn-manager-primary">
        <i class="bi bi-image"></i> Экспорт в PNG
      </a>
    </div>
  </div>
  
  <!-- Общая статистика -->
  <div class="stats-grid mb-4">
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Авторизованные клиенты</div>
        <div class="stat-card-icon primary">
          <i class="bi bi-person-check"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ total_customers }}</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Гостевые клиенты</div>
        <div class="stat-card-icon info">
          <i class="bi bi-person"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ total_guest_customers }}</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Новые клиенты</div>
        <div class="stat-card-icon success">
          <i class="bi bi-person-plus"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ new_customers }}</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Общая выручка</div>
        <div class="stat-card-icon success">
          <i class="bi bi-currency-exchange"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ total_revenue|floatformat:0 }} ₽</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Средний чек</div>
        <div class="stat-card-icon warning">
          <i class="bi bi-graph-up"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ avg_order_value|floatformat:0 }} ₽</div>
    </div>
  </div>
  
  <!-- Топ клиентов (авторизованные) -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Топ-20 клиентов (авторизованные)</h3>
    </div>
    {% if customer_stats %}
      <div class="table-responsive">
        <table class="table-manager">
          <thead>
            <tr>
              <th>Клиент</th>
              <th>Email</th>
              <th>Количество заказов</th>
              <th>Общая сумма</th>
              <th>Средний чек</th>
              <th>Последний заказ</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in customer_stats %}
            <tr>
              <td>
                <strong>
                  {% if stat.user__first_name or stat.user__last_name %}
                    {{ stat.user__first_name|default:'' }} {{ stat.user__last_name|default:'' }}
                  {% else %}
                    Клиент #{{ stat.user__id }}
                  {% endif %}
                </strong>
              </td>
              <td>{{ stat.user__email }}</td>
              <td><strong>{{ stat.total_orders }}</strong></td>
              <td><strong>{{ stat.total_spent|floatformat:2 }} ₽</strong></td>
              <td>{{ stat.avg_order_value|floatformat:2 }} ₽</td>
              <td>{{ stat.last_order_date|date:"d.m.Y H:i" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted text-center py-4">Нет данных по авторизованным клиентам</p>
    {% endif %}
  </div>
  
  <!-- Топ гостевых клиентов -->
  {% if guest_stats %}
  <div class="data-card mt-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Топ-10 гостевых клиентов (по email)</h3>
    </div>
    <div class="table-responsive">
      <table class="table-manager">
        <thead>
          <tr>
            <th>Email</th>
            <th>Количество заказов</th>
            <th>Общая сумма</th>
            <th>Средний чек</th>
            <th>Последний заказ</th>
          </tr>
        </thead>
        <tbody>
          {% for stat in guest_stats %}
          <tr>
            <td><strong>{{ stat.email }}</strong></td>
            <td><strong>{{ stat.total_orders }}</strong></td>
            <td><strong>{{ stat.total_spent|floatformat:2 }} ₽</strong></td>
            <td>{{ stat.avg_order_value|floatformat:2 }} ₽</td>
            <td>{{ stat.last_order_date|date:"d.m.Y H:i" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

