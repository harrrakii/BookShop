{% extends 'manager/base.html' %}

{% block title %}–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞{% endblock %}
{% block page_title %}üìã –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞{% endblock %}
{% block page_description %}–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ{% endblock %}

{% block content %}
  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">–§–∏–ª—å—Ç—Ä—ã</h3>
    </div>
    <form method="get" action="{% url 'manager_audit_log' %}" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">–ú–æ–¥–µ–ª—å:</label>
        <select name="model" class="form-select">
          <option value="">–í—Å–µ –º–æ–¥–µ–ª–∏</option>
          {% for model in all_models %}
          <option value="{{ model }}" {% if model_filter == model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">–î–µ–π—Å—Ç–≤–∏–µ:</label>
        <select name="action" class="form-select">
          <option value="">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
          {% for value, label in action_choices %}
          <option value="{{ value }}" {% if action_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
        <select name="user" class="form-select">
          <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
          {% for u in users_with_changes %}
          <option value="{{ u.id }}" {% if user_filter == u.id|stringformat:"s" %}selected{% endif %}>{{ u.email }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">–ü–æ–∏—Å–∫:</label>
        <input type="text" name="q" class="form-control" placeholder="–ü–æ–∏—Å–∫..." value="{{ search_query }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">–î–∞—Ç–∞ –æ—Ç:</label>
        <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">–î–∞—Ç–∞ –¥–æ:</label>
        <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-manager btn-manager-primary">
          <i class="bi bi-funnel"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
        <a href="{% url 'manager_audit_log' %}" class="btn btn-manager btn-manager-secondary">
          <i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å
        </a>
      </div>
    </form>
  </div>
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-grid mb-4">
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
        <div class="stat-card-icon primary">
          <i class="bi bi-journal-text"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ total_logs }}</div>
    </div>
  </div>
  
  <div class="row g-4 mb-4">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">–ü–æ –¥–µ–π—Å—Ç–≤–∏—è–º</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
              <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in stats_by_action %}
            <tr>
              <td>
                {% for value, label in action_choices %}
                  {% if stat.action == value %}{{ label }}{% endif %}
                {% endfor %}
              </td>
              <td><strong>{{ stat.count }}</strong></td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–æ–¥–µ–ª—è–º -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">–ü–æ –º–æ–¥–µ–ª—è–º</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>–ú–æ–¥–µ–ª—å</th>
              <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in stats_by_model %}
            <tr>
              <td><strong>{{ stat.model_name }}</strong></td>
              <td><strong>{{ stat.count }}</strong></td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- –ñ—É—Ä–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <div class="data-card">
    <div class="data-card-header">
      <h3 class="data-card-title">–ñ—É—Ä–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π ({{ total_logs }})</h3>
    </div>
    
    {% if audit_logs %}
      <div class="table-responsive">
        <table class="table-manager">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
              <th>–ú–æ–¥–µ–ª—å</th>
              <th>–û–±—ä–µ–∫—Ç</th>
              <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
              <th>–ò–∑–º–µ–Ω–µ–Ω–∏—è</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody>
            {% for log in audit_logs %}
            <tr>
              <td>{{ log.created_at|date:"d.m.Y H:i:s" }}</td>
              <td>
                <span class="badge-manager 
                  {% if log.action == 'create' %}badge-new
                  {% elif log.action == 'update' %}badge-processing
                  {% elif log.action == 'delete' %}badge-cancelled
                  {% elif log.action == 'view' %}badge-info
                  {% elif log.action == 'login' or log.action == 'register' %}badge-success
                  {% elif log.action == 'logout' %}badge-secondary
                  {% elif log.action == 'download' or log.action == 'export' %}badge-primary
                  {% elif log.action == 'import' or log.action == 'config' %}badge-warning
                  {% else %}badge-secondary{% endif %}">
                  {{ log.get_action_display }}
                </span>
              </td>
              <td><strong>{{ log.model_name|default:"‚Äî" }}</strong></td>
              <td>
                {% if log.object_repr %}
                  {{ log.object_repr|truncatechars:30 }}
                {% elif log.description %}
                  {{ log.description|truncatechars:30 }}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>
                {% if log.user %}
                  {{ log.user.email|truncatechars:20 }}
                {% else %}
                  <span class="text-muted">–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π</span>
                {% endif %}
              </td>
              <td>
                {% if log.changes %}
                  <button type="button" class="btn btn-sm btn-manager btn-manager-secondary" 
                          data-bs-toggle="modal" 
                          data-bs-target="#changesModal{{ log.id }}">
                    <i class="bi bi-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å
                  </button>
                {% elif log.description %}
                  <button type="button" class="btn btn-sm btn-manager btn-manager-secondary" 
                          data-bs-toggle="modal" 
                          data-bs-target="#detailsModal{{ log.id }}">
                    <i class="bi bi-info-circle"></i> –î–µ—Ç–∞–ª–∏
                  </button>
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td><small class="text-muted">{{ log.ip_address|default:"‚Äî" }}</small></td>
            </tr>
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ -->
            {% if log.changes %}
            <div class="modal fade" id="changesModal{{ log.id }}" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ {{ log.model_name }} #{{ log.object_id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>–ü–æ–ª–µ</th>
                          <th>–ë—ã–ª–æ</th>
                          <th>–°—Ç–∞–ª–æ</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for field, values in log.changes.items %}
                        <tr>
                          <td><strong>{{ field }}</strong></td>
                          <td>
                            <span class="badge bg-danger">{{ values.old|default:"‚Äî" }}</span>
                          </td>
                          <td>
                            <span class="badge bg-success">{{ values.new|default:"‚Äî" }}</span>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    <div class="mt-3">
                      <small class="text-muted">
                        <strong>–î–∞—Ç–∞:</strong> {{ log.created_at|date:"d.m.Y H:i:s" }}<br>
                        {% if log.user %}
                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ log.user.email }}<br>
                        {% endif %}
                        {% if log.ip_address %}
                        <strong>IP:</strong> {{ log.ip_address }}<br>
                        {% endif %}
                        {% if log.url_path %}
                        <strong>URL:</strong> {{ log.url_path }}
                        {% endif %}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –¥–µ–π—Å—Ç–≤–∏—è -->
            {% if log.description and not log.changes %}
            <div class="modal fade" id="detailsModal{{ log.id }}" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                      <p>{{ log.description }}</p>
                    </div>
                    {% if log.model_name %}
                    <div class="mb-3">
                      <strong>–ú–æ–¥–µ–ª—å:</strong> {{ log.model_name }}
                      {% if log.object_id %}#{{ log.object_id }}{% endif %}
                    </div>
                    {% endif %}
                    <div class="mt-3">
                      <small class="text-muted">
                        <strong>–î–∞—Ç–∞:</strong> {{ log.created_at|date:"d.m.Y H:i:s" }}<br>
                        {% if log.user %}
                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ log.user.email }}<br>
                        {% else %}
                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π<br>
                        {% endif %}
                        {% if log.ip_address %}
                        <strong>IP:</strong> {{ log.ip_address }}<br>
                        {% endif %}
                        {% if log.url_path %}
                        <strong>URL:</strong> {{ log.url_path }}<br>
                        {% endif %}
                        {% if log.user_agent %}
                        <strong>User Agent:</strong> {{ log.user_agent|truncatechars:100 }}
                        {% endif %}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
      {% if audit_logs.has_other_pages %}
      <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if audit_logs.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ audit_logs.previous_page_number }}{% if model_filter %}&model={{ model_filter }}{% endif %}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
          </li>
          {% endif %}
          
          <li class="page-item active">
            <span class="page-link">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ audit_logs.number }} –∏–∑ {{ audit_logs.paginator.num_pages }}</span>
          </li>
          
          {% if audit_logs.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ audit_logs.next_page_number }}{% if model_filter %}&model={{ model_filter }}{% endif %}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">–°–ª–µ–¥—É—é—â–∞—è</a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    {% else %}
      <p class="text-muted text-center py-4">–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
    {% endif %}
  </div>
{% endblock %}
