{% extends 'manager/base.html' %}

{% block title %}Отчеты{% endblock %}
{% block page_title %}Отчеты{% endblock %}
{% block page_description %}Детальные отчеты по заказам и клиентам с фильтрами и экспортом{% endblock %}

{% block content %}
  <!-- Вкладки -->
  <ul class="nav nav-tabs mb-4" id="reportsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab" aria-controls="orders" aria-selected="true">
        <i class="bi bi-cart-check"></i> Отчет по заказам
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab" aria-controls="customers" aria-selected="false">
        <i class="bi bi-people"></i> Отчет по клиентам
      </button>
    </li>
  </ul>

  <div class="tab-content" id="reportsTabsContent">
    <!-- Вкладка: Отчет по заказам -->
    <div class="tab-pane fade show active" id="orders" role="tabpanel" aria-labelledby="orders-tab">
  <!-- Фильтры -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Фильтры</h3>
    </div>
    <form method="get" action="{% url 'manager_reports' %}" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Дата от:</label>
        <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Дата до:</label>
        <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Статус:</label>
        <select name="status" class="form-select">
          <option value="">Все</option>
          {% for value, label in status_choices %}
          <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Тип доставки:</label>
        <select name="fulfillment_type" class="form-select">
          <option value="">Все</option>
          {% for value, label in fulfillment_choices %}
          <option value="{{ value }}" {% if fulfillment_type == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-manager btn-manager-primary">
          <i class="bi bi-funnel"></i> Применить фильтры
        </button>
        <a href="{% url 'manager_reports' %}" class="btn btn-manager btn-manager-secondary">
          <i class="bi bi-arrow-counterclockwise"></i> Сбросить
        </a>
      </div>
    </form>
  </div>
  
  <!-- Кнопки экспорта -->
  <div class="data-card mb-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Экспорт отчета</h3>
    </div>
    <div class="d-flex gap-3">
      <a href="{% url 'manager_reports_export_csv' %}?{{ request.GET.urlencode }}" class="btn btn-manager btn-manager-primary">
        <i class="bi bi-file-earmark-spreadsheet"></i> Экспорт в CSV
      </a>
      <a href="{% url 'manager_reports_export_image' %}?{{ request.GET.urlencode }}" class="btn btn-manager btn-manager-primary">
        <i class="bi bi-image"></i> Экспорт в PNG
      </a>
    </div>
  </div>
  
  <!-- Общая статистика -->
  <div class="stats-grid mb-4">
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Всего заказов</div>
        <div class="stat-card-icon primary">
          <i class="bi bi-cart-check"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ total_orders }}</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Общая выручка</div>
        <div class="stat-card-icon success">
          <i class="bi bi-currency-exchange"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ total_revenue|floatformat:0 }} ₽</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Средний чек</div>
        <div class="stat-card-icon info">
          <i class="bi bi-graph-up"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ avg_order_value|floatformat:0 }} ₽</div>
    </div>
  </div>
  
  <div class="row g-4">
    <!-- Статистика по статусам -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">Статистика по статусам</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>Статус</th>
              <th>Количество</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in status_stats %}
            <tr>
              <td>
                <span class="badge-manager badge-{{ stat.status }}">
                  {% for value, label in status_choices %}
                    {% if stat.status == value %}{{ label }}{% endif %}
                  {% endfor %}
                </span>
              </td>
              <td><strong>{{ stat.count }}</strong></td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-center text-muted">Нет данных</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Статистика по типам доставки -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="data-card-header">
          <h3 class="data-card-title">Статистика по типам доставки</h3>
        </div>
        <table class="table-manager">
          <thead>
            <tr>
              <th>Тип доставки</th>
              <th>Количество</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in fulfillment_stats %}
            <tr>
              <td>
                {% for value, label in fulfillment_choices %}
                  {% if stat.fulfillment_type == value %}{{ label }}{% endif %}
                {% endfor %}
              </td>
              <td><strong>{{ stat.count }}</strong></td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-center text-muted">Нет данных</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Топ товаров -->
  <div class="data-card mt-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Топ-10 товаров</h3>
    </div>
    <table class="table-manager">
      <thead>
        <tr>
          <th>Товар</th>
          <th>Тип</th>
          <th>Количество продано</th>
          <th>Выручка</th>
        </tr>
      </thead>
      <tbody>
        {% for product in top_products %}
        <tr>
          <td><strong>{{ product.name }}</strong></td>
          <td>{{ product.product_type }}</td>
          <td>{{ product.total_quantity }}</td>
          <td><strong>{{ product.total_revenue|floatformat:2 }} ₽</strong></td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted">Нет данных</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Список заказов -->
  <div class="data-card mt-4">
    <div class="data-card-header">
      <h3 class="data-card-title">Заказы (первые 100)</h3>
    </div>
    {% if orders %}
      <div class="table-responsive">
        <table class="table-manager">
          <thead>
            <tr>
              <th>ID</th>
              <th>Дата</th>
              <th>Клиент</th>
              <th>Email</th>
              <th>Сумма</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr>
              <td><strong>#{{ order.id }}</strong></td>
              <td>{{ order.created_at|date:"d.m.Y H:i" }}</td>
              <td>{{ order.full_name }}</td>
              <td>{{ order.email }}</td>
              <td><strong>{{ order.total_amount|floatformat:2 }} ₽</strong></td>
              <td>
                <span class="badge-manager badge-{{ order.status }}">
                  {{ order.get_status_display }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted text-center py-4">Нет заказов</p>
    {% endif %}
  </div>
    </div>
    
    <!-- Вкладка: Отчет по клиентам -->
    <div class="tab-pane fade" id="customers" role="tabpanel" aria-labelledby="customers-tab">
      <!-- Фильтры для отчета по клиентам -->
      <div class="data-card mb-4">
        <div class="data-card-header">
          <h3 class="data-card-title">Фильтры</h3>
        </div>
        <form method="get" action="{% url 'manager_reports' %}" class="row g-3">
          <input type="hidden" name="tab" value="customers">
          <div class="col-md-4">
            <label class="form-label">Дата от:</label>
            <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Дата до:</label>
            <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-manager btn-manager-primary me-2">
              <i class="bi bi-funnel"></i> Применить фильтры
            </button>
            <a href="{% url 'manager_reports' %}?tab=customers" class="btn btn-manager btn-manager-secondary">
              <i class="bi bi-arrow-counterclockwise"></i> Сбросить
            </a>
          </div>
        </form>
      </div>
      
      <!-- Кнопки экспорта -->
      <div class="data-card mb-4">
        <div class="data-card-header">
          <h3 class="data-card-title">Экспорт отчета</h3>
        </div>
        <div class="d-flex gap-3">
          <a href="{% url 'manager_reports_customers_export_csv' %}?{{ request.GET.urlencode }}" class="btn btn-manager btn-manager-primary">
            <i class="bi bi-file-earmark-spreadsheet"></i> Экспорт в CSV
          </a>
          <a href="{% url 'manager_reports_customers_export_image' %}?{{ request.GET.urlencode }}" class="btn btn-manager btn-manager-primary">
            <i class="bi bi-image"></i> Экспорт в PNG
          </a>
        </div>
      </div>
      
      <!-- Общая статистика -->
      <div class="stats-grid mb-4">
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Авторизованные клиенты</div>
            <div class="stat-card-icon primary">
              <i class="bi bi-person-check"></i>
            </div>
          </div>
          <div class="stat-card-value">{{ total_customers }}</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Гостевые клиенты</div>
            <div class="stat-card-icon info">
              <i class="bi bi-person"></i>
            </div>
          </div>
          <div class="stat-card-value">{{ total_guest_customers }}</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Новые клиенты</div>
            <div class="stat-card-icon success">
              <i class="bi bi-person-plus"></i>
            </div>
          </div>
          <div class="stat-card-value">{{ new_customers }}</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Общая выручка</div>
            <div class="stat-card-icon success">
              <i class="bi bi-currency-exchange"></i>
            </div>
          </div>
          <div class="stat-card-value">{{ total_revenue|floatformat:0 }} ₽</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Средний чек</div>
            <div class="stat-card-icon warning">
              <i class="bi bi-graph-up"></i>
            </div>
          </div>
          <div class="stat-card-value">{{ avg_order_value|floatformat:0 }} ₽</div>
        </div>
      </div>
      
      <!-- Топ клиентов (авторизованные) -->
      <div class="data-card mb-4">
        <div class="data-card-header">
          <h3 class="data-card-title">Топ-20 клиентов (авторизованные)</h3>
        </div>
        {% if customer_stats %}
          <div class="table-responsive">
            <table class="table-manager">
              <thead>
                <tr>
                  <th>Клиент</th>
                  <th>Email</th>
                  <th>Количество заказов</th>
                  <th>Общая сумма</th>
                  <th>Средний чек</th>
                  <th>Последний заказ</th>
                </tr>
              </thead>
              <tbody>
                {% for stat in customer_stats %}
                <tr>
                  <td>
                    <strong>
                      {% if stat.user__first_name or stat.user__last_name %}
                        {{ stat.user__first_name|default:'' }} {{ stat.user__last_name|default:'' }}
                      {% else %}
                        Клиент #{{ stat.user__id }}
                      {% endif %}
                    </strong>
                  </td>
                  <td>{{ stat.user__email }}</td>
                  <td><strong>{{ stat.total_orders }}</strong></td>
                  <td><strong>{{ stat.total_spent|floatformat:2 }} ₽</strong></td>
                  <td>{{ stat.avg_order_value|floatformat:2 }} ₽</td>
                  <td>{{ stat.last_order_date|date:"d.m.Y H:i" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted text-center py-4">Нет данных по авторизованным клиентам</p>
        {% endif %}
      </div>
      
      <!-- Топ гостевых клиентов -->
      {% if guest_stats %}
      <div class="data-card mt-4">
        <div class="data-card-header">
          <h3 class="data-card-title">Топ-10 гостевых клиентов (по email)</h3>
        </div>
        <div class="table-responsive">
          <table class="table-manager">
            <thead>
              <tr>
                <th>Email</th>
                <th>Количество заказов</th>
                <th>Общая сумма</th>
                <th>Средний чек</th>
                <th>Последний заказ</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in guest_stats %}
              <tr>
                <td><strong>{{ stat.email }}</strong></td>
                <td><strong>{{ stat.total_orders }}</strong></td>
                <td><strong>{{ stat.total_spent|floatformat:2 }} ₽</strong></td>
                <td>{{ stat.avg_order_value|floatformat:2 }} ₽</td>
                <td>{{ stat.last_order_date|date:"d.m.Y H:i" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <script>
    // Сохранение активной вкладки при перезагрузке
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');
      
      if (tab === 'customers') {
        const customersTab = new bootstrap.Tab(document.getElementById('customers-tab'));
        customersTab.show();
      }
    });
  </script>
{% endblock %}


